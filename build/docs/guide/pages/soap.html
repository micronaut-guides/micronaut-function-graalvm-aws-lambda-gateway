<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>2.2 VAT SOAP Service null</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Micronaut Functions in GraalVM Native Images deployed to AWS Lambda
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/gettingStarted.html"><strong>1</strong><span>Introduction</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/writingTheApp.html"><strong>2</strong><span>Writing the Application</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/runningTheApp.html"><strong>3</strong><span>Running the Application</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/gettingStarted.html">&lt;&lt; <strong>1</strong><span>Introduction</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../../guide/runningTheApp.html"><strong>3</strong><span>Running the Application</span> >></a></div>
                


                <div class="project">
                    <h1>2.2 VAT SOAP Service</h1>

                    <p><strong>Version:</strong> null</p>
                </div>

                

                

<h2 id="soap">2.2 VAT SOAP Service</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway/edit/master/src/main/docs/guide/writingTheApp/soap.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>VIES (<a href="http://ec.europa.eu/taxation_customs/vies/faq.html">VAT Information Exchange System</a>) is an electronic mean of validating VAT-identification numbers of economic operators registered in the European Union for cross border transactions on goods or services.</p>
</div>
<div class="paragraph">
<p>For example, if you create an e-commerce Web application in the European union you would need to check the validity of the purchaser&#8217;s
VAT Number in order to create a proper invoice.</p>
</div>
<div class="paragraph">
<p>To automate the validation checks, the EU does not offer a REST endpoint but a SOAP service. Its WSDL file can be obtained <a href="http://ec.europa.eu/taxation_customs/vies/checkVatService.wsdl">here</a>.</p>
</div>
<div class="paragraph">
<p><strong>SOAP</strong> (originally Simple Object Access Protocol) is a protocol specification for exchanging structured information in the implementation of web services in computer networks. Its purpose is to induce extensibility, neutrality and independence</p>
</div>
<div class="paragraph">
<p>Create <code>VatService</code> to do a SOAP request to validate the VAT Number.</p>
</div>
<div class="paragraph">
<p>To consume the SOAP service we could have use a SOAP library. However, the use case is so simple we are going to use the Micronaut HTTP Client and build
the SOAP envelope manually.</p>
</div>
<div class="paragraph">
<p>Add <code>http-client</code> dependency to <code>build.gradle</code></p>
</div>
<div class="listingblock">
<div class="title">vat-validator-graal/build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">    compile "io.micronaut:micronaut-http-client"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a <code>VatService</code> which consumes the SOAP Service:</p>
</div>
<div class="listingblock">
<div class="title">vat-validator-graal/src/main/java/example/micronaut/VatService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.http.HttpRequest;
import io.micronaut.http.client.RxHttpClient;
import io.micronaut.http.client.annotation.Client;
import io.reactivex.Flowable;
import io.reactivex.Single;

import javax.inject.Singleton;

@Singleton <i class="conum" data-value="1"></i><b>(1)</b>
public class VatService {
    private static final String SERVER = "http://ec.europa.eu";
    private static final String PATH = "/taxation_customs/vies/services/checkVatService";
    private static final String VALID_XML_OPEN_TAG = "&lt;valid&gt;";
    private static final String VALID_XML_CLOSE_TAG = "&lt;/valid&gt;";

    protected final RxHttpClient client;

    public VatService(@Client("http://ec.europa.eu") RxHttpClient client) { <i class="conum" data-value="2"></i><b>(2)</b>
        this.client = client;
    }

    public Single&lt;Boolean&gt; validateVat(String memberStateCode, String vatNumber) {
        String soapEnvelope = soapEnvelope(memberStateCode, vatNumber);
        HttpRequest request = HttpRequest.POST(SERVER+PATH, soapEnvelope)  <i class="conum" data-value="3"></i><b>(3)</b>
                .contentType("application/soap+xml");

        Flowable&lt;String&gt; response = client.retrieve(request, String.class);
        return response.firstOrError().map(this::parseResponseToBoolean);
    }

    private Boolean parseResponseToBoolean(String response) {
        if (!response.contains(VALID_XML_OPEN_TAG) || !response.contains(VALID_XML_CLOSE_TAG)) {
            return false;
        }
        int beginIndex = response.indexOf(VALID_XML_OPEN_TAG) + VALID_XML_OPEN_TAG.length();
        String validResponse = response.substring(beginIndex, response.indexOf(VALID_XML_CLOSE_TAG));
        return Boolean.valueOf(validResponse);
    }

    private String soapEnvelope(String memberStateCode, String vatNumber) {
        StringBuilder sb = new StringBuilder();
        sb.append("&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;");
        sb.append("&lt;soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\"&gt;");
        sb.append("&lt;soapenv:Header/&gt;");
        sb.append("&lt;soapenv:Body xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\"&gt;");
        sb.append("&lt;urn:checkVat xmlns:urn=\"urn:ec.europa.eu:taxud:vies:services:checkVat:types\"&gt;");
        sb.append("&lt;urn:countryCode&gt;");
        sb.append(memberStateCode);
        sb.append("&lt;/urn:countryCode&gt;");
        sb.append("&lt;urn:vatNumber&gt;");
        sb.append(vatNumber);
        sb.append("&lt;/urn:vatNumber&gt;");
        sb.append("&lt;/urn:checkVat&gt;");
        sb.append("&lt;/soapenv:Body&gt;");
        sb.append("&lt;/soapenv:Envelope&gt;");
        return sb.toString();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>javax.inject.Singleton</code> to designate a class a a singleton</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Constructor Injection of Micronaut RxClient</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define a POST Request.</td>
</tr>
</table>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/gettingStarted.html">&lt;&lt; <strong>1</strong><span>Introduction</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/runningTheApp.html"><strong>3</strong><span>Running the Application</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
